const assert = require('assert');
const dbconnection = require('../../database/dbconnection')

let controller = {
    validateUser:(req, res, next) => {
        let user = req.body;
        let{firstName, 
            lastName, 
            street, 
            city, 
            emailAdress, 
            password, 
            phoneNumber} = user;

    
        try {
            assert(typeof firstName === 'string', 'First name must be a string')
            assert(typeof lastName === 'string', 'Last name must be a string')
            assert(typeof street === 'string', 'Street must be a string')
            assert(typeof city === 'string', 'City must be a string')
            assert(typeof emailAdress === 'string', 'Email must be a string')
            assert(emailAdress.match(/^([\w\.\-_]+)?\w+@[\w-_]+(\.\w+){1,}$/i), 'Invalid email format');
            assert(typeof password === 'string', 'Password must be a string')
            assert(password.match(/^.{6,}$/) || password.match(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/), 'Invalid password format');


        } catch (err) {
            const error = {
                status: 400,
                message: err.message,
            };
            next(error)
        }
        next();
    },

    validateUserUpdate:(req, res, next) => {
        let user = req.body;
        let{firstName, 
            lastName, 
            street, 
            city, 
            emailAdress, 
            password, 
            phoneNumber} = user;

    
        try {

            assert(typeof emailAdress === 'string', 'Email must be a string')
            assert(emailAdress.match(/^([\w\.\-_]+)?\w+@[\w-_]+(\.\w+){1,}$/i), 'Invalid email format');
            assert(typeof phoneNumber === 'string', 'Phonenumber must be a string')
            assert(phoneNumber.match(/^(((\\+31|0|0031)6){1}\-{1}[1-9]{1}[0-9]{7})$/), 'Invalid phone number format');

        } catch (err) {
            const error = {
                status: 400,
                message: err.message,
            };
            next(error)
        }
        next();
    },

    userExists: (req, res, next) => {
        dbconnection.getConnection(function (err, connection) {
            const id = req.params.userId;

            if(isNaN(id)){ 
                return next()
            } 
            connection.query(
                'SELECT COUNT(id) as count FROM user WHERE id = ?', `${id}`,
                function (err, results, fields) {

                    if (err) throw err;

                    if (results[0].count === 0) {
                        res.status(400).json({
                            status: 400,
                            message: "User does not exist",
                        });
                    } else {
                        next();
                    }
                });
        });
    },

    addUser:(req, res) => {
   
        dbconnection.getConnection(function (err, connection) {
            if (err) throw err;

            let user = req.body;

            connection.query(
                'SELECT COUNT(emailAdress) as count FROM user WHERE emailAdress = ?', user.emailAdress,
                function (error, results, fields) {
                    connection.release();

                    if (error) throw error;

                    if (results[0].count > 0) {
                        res.status(409).json({
                            status: 409,
                            message: `Email is already in use.`,
                        });
                    } else {
                        connection.query(                    
                            `INSERT INTO user (firstName, lastName, street, city, password, emailAdress) VALUES ('${user.firstName}', '${user.lastName}', '${user.street}', '${user.city}', '${user.password}', '${user.emailAdress}')`,
                            function (error, results, fields) {       
                                if (error) throw error;
                                if (results.affectedRows > 0) {

                                connection.query("SELECT * FROM user WHERE emailAdress = ?", user.emailAdress, function(error, results, fields) {
                                    if (error) throw error;
                                    connection.release();

                                    if (results[0].isActive === 1) {
                                        results[0].isActive = true;
                                    } else {
                                        results[0].isActive = false;
                                    }

                                    res.status(201).json({
                                        status: 201,
                                        result: results[0],
                                    });
                                })
                                                          
                                }
                            });
                    }
                });
        });
    },

    getAllUsers:(req, res) => {
        let {firstName, isActive, limit} = req.query
        console.log(`name = ${firstName} isActive ${isActive}`)

        let queryString = 'SELECT * FROM `user`'
        if (firstName || isActive) {
            queryString += ' WHERE '
            if (firstName) {
                queryString += '`firstName` LIKE ?'
                firstName = '%' + firstName + '%'
            }
            if (firstName && isActive) {
                queryString += ' AND '
            }
            if (isActive === "true") {
                queryString += `isActive = 1`
            }
            if (isActive === "false") {
                queryString += `isActive = 0`
            }
        }

        if (limit) {
            queryString += "LIMIT " + limit;
        }

        console.log(queryString);

        dbconnection.getConnection(function(err, connection) {
            if (err){
                next(err)
            }; // not connected!
           
            // Use the connection
            connection.query(queryString, [firstName, isActive], function (error, results, fields) {
              // When done with the connection, release it.
              connection.release();
           
              // Handle error after the release.
              if (error) throw error;
           
              // Don't use the connection here, it has been returned to the pool.
              console.log('#results = ', results.length)
              res.status(200).json({
                  status: 200,
                  result: results
              })
        
            });
        });
    },

    getUserProfile:(req, res, next) => {
        dbconnection.getConnection(function (error, connection) {
            if (error) throw error;

            const userId = req.userId
            console.log(userId)

                connection.query( 'SELECT * FROM user WHERE id = ?', [userId], function (error, results, fields) {
                    if (error) throw error;
                        
                    connection.release();
    
                    console.log('#results = ', results.length);
                    res.status(200).json({
                        status: 200,
                        result: results[0],
                    });
                });
        });
    },

    getUserById:(req, res, next) => {
        console.log("getUserById reached");
        dbconnection.getConnection(function (error, connection) {
            if (error) throw error;

            const userId = req.params.userId

            if(isNaN(userId)) {
                return next();
            }

            connection.query("SELECT COUNT(id) as count FROM user WHERE id =?", userId,  function (error, results, fields) {
                if (error) throw error;
                if(!results[0].count) {
                    return next({
                        status: 404,
                        message: `User doesn't exist`,
                    });
                } else {
                    connection.query( 'SELECT * FROM user WHERE id = ?', userId, function (error, results, fields) {
                        if (error) throw error;
                        
                        connection.release();
    
                        console.log('#results = ', results.length);
                        res.status(200).json({
                            status: 200,
                            result: results[0],
                        });
                    });
                }
            });
        });
    },

    updateUser:(req, res, next) => {
        //create connection
        dbconnection.getConnection((err, connection) => {
            //throw error if something went wrong
            if (err) throw err;
    
            //save parameter (id) in variable
            const id = Number(req.params.id);
    
            if (req.userId === id) {

            const newUser = req.body;
    
            //check if parameter is a number
            if (isNaN(id)) {
                return next();
            }
    
            //set user object with given request body
            let user = req.body;
    
            connection.query("SELECT * FROM user WHERE id = ?", id, (err, results, fields) => {
                //throw error if something went wrong
                if (err) throw err;
    
                //store old data
                const oldUser = results[0];
    
                //if user exists
                if (results[0]) {
                    connection.query("SELECT COUNT(emailAdress) as count FROM user WHERE emailAdress = ? AND id <> ?", [oldUser.emailAdress, id], (err, results, fields) => {
                        //throw error if something went wrong
                        if (err) throw err;
    
                        //store if email is valid or not, can either be 0 or 1
                        const inValidEmail = results[0].count;
    
                        if (!inValidEmail) {
                            //put request body in a variable
    
                            const user = {
                                ...oldUser,
                                ...newUser,
                            };
    
                            const { firstName, lastName, emailAdress, password, street, city, phoneNumber } = user;
    
                            //update user
                            connection.query("UPDATE user SET firstName = ?, lastName = ?, emailAdress = ?, password = ?, street = ?, city = ?, phoneNumber = ? WHERE id = ?", [firstName, lastName, emailAdress, password, street, city, phoneNumber, id], (err, results, fields) => {
                                //throw error if something went wrong
                                if (err) throw err;
    
                                //close connection
                                connection.release();
    
                                //return successful status + updated user
                                res.status(200).json({
                                    status: 200,
                                    result: user,
                                });
    
                                //end response process
                                // res.end();
                            });
                        } else {
                            //return false status if email is already in use by another user
                            return next({
                                status: 409,
                                message: `Email is already in use`,
                            });
                        }
                    });
                } else {
                    //if the user isn't found return a fitting error response
                    return next({
                        status: 400,
                        message: `User doesn't exist`,
                    });
                }
            });
        } else {
            return next({
                status: 401,
                message: `No permission to edit this user, not logged in`,
            });
        }
        });
},

    deleteUser:(req, res, next) => {
        console.log("deleteUser reached");
        dbconnection.getConnection(function (err, connection) {
            if (err) throw err;

            const userId = Number(req.params.userId);

            if(req.userId === userId){

                if (isNaN(userId)) {
                    next()
                }

                connection.query(
                    `DELETE FROM user WHERE id = '${userId}'`,
                    function (error, results, fields) {
                        connection.release();

                        if (error) throw error;

                        console.log('#results = ', results.length);
                        res.status(200).json({
                            status: 200,
                            message: "User has been deleted",
                        });

                        res.end();
                    });
            } else {
                return next({
                    status: 403,
                    message: `No permission to delete this user, no owner rights`,
                });
            }
        });
    },
}

module.exports = controller;